This page in [English](/docs/en/meta_report.md)

# Настройка метаданных отчета

Отчеты формируются на основе данных класса, указанного для свойства `className`. Исходный источник данных `dataSource` извлекает данные из меты соответствующего класса. Отчет строится на основе значений атрибутов, указанных в свойстве `results`. 
```yml
- name: dataSource # системное имя источника данных
    caption: Источник данных
    load:
      - className: sourceClass # класс, на основе данных которого формируется отчет
        filter: # фильтр, по условиям которого выполняется отбор объектов источников данных
          ne:
            - $archive
            - true
        results: # атрибуты класса
          - field: id # определяем системное имя на уровне отчета
            expr: $id # системное имя атрибута из меты класса
          - field: date
            expr: $dateCreate
          - field: name
            expr: $nameObject
    index: # идентификатор источника данных
      - id
```
Для *source* на основе классов фильтры указываются через *Conditions*.

Далее, создаем результирующий источник, который на основе данных, полученных исходным источником из меты класса, выполняется формирование и преобразование (при необходимости) данных для корректного отображения в таблицах отчета. Исходный источник указывается в свойстве `source`. Свойство `joins` задает атрибут, который является идентификатором для построения отчета (в данном случае id объекта).
```yml
- name: test # системное имя результирующего источника данных
    caption: Отчет тестовый
    load:
      - source: dataTest # определяется исходный источник данных
        joins: # идентификатор для построения отчета
          - table: date
            alias: da
            left: id
            right: id
        results:
          - field: id
            expr: $id
          - field: date
            expr: $date
          - field: name
            expr: $name
```

Далее, в разделе `reports` формируется таблица отчета, на основе преобразованных данных из источника. Свойство `rangeFilters` содержит информацию о фильтрах, настраиваемых для отчета. Свойство `columns` позволяет формировать колонки таблицы (порядковые номера фактические).
```yml
reports: # построение таблиц отчета
  - name: reportTest
    caption: Отчет тестовый
    sheets:
      - name: reportTest
        caption: Отчет тестовый
        type: aggregation
        source: test # источник получения данных для таблицы отчета
        fetch: # объявление атрибутов, участвующих в формировании отчета
          date: $date
          name: $name
        rangeFilters: # фильтр по диапазону дат
          date:
            caption: За период с|по
            format: date
            inclusive: both
        columns: # формирование колонок таблицы отчета
          - field: date # системное имя атрибута на уровне отчета
            caption: Дата создания # наименование колонки таблицы отчета
          - field: name
            caption: Наименование
        groups: # группировка
          fields: # по полю отчета
            - date
```

В итоге отчет состоит из таблицы с двумя колонками (Дата и Наименование). В таблице будут выводится объекты класса из источника _"dataSource"_ , в соответствии с фильтром по датам, настроенном в `rangeFilters:`, а количество объектов в таблице будет равно количеству значений идентификатора, настроенном в свойстве `joins:`.

Фильтр по диапазону задается через параметры запроса `?rangeFld[]=0&rangeFld[]=5`, где `rangeFld` - это поле по которому ищем. Если идет поиск по датам - то необходимо передавать ее в формате локали, которая передается в http-заголовке `'accept-language'`, либо в формате `ISO8601`. 

Описание **параметра строгости сравнения `inclusive`** на границах интервала `rangeFilters` в отчете:
```yml
"rangeFilters": {
  "date": {
    "caption": "За период с|по",
    "format": "date",
    "inclusive": "both" | "left" | "right"
  }
}
```
`both` - обе границы могут быть равны искомым значениям

`left` - левая граница (меньшая) может быть равна искомым значениям 

`right` - правая граница (большая) может быть равна искомым значениям

Если `inclusive` не указан - сравнение строгое на обоих границах.

На форме отчета в поля фильтра указывается диапазон, в который входит дата, заданная для атрибута **"date"**. 

Пример простого полного отчета можно посмотреть [здесь](/docs/ru/2_system_description/metadata_structure/meta_report/example.md).

## Дополнительные настройки в отчете

1. **Настройка иерархической сборки в шахте данных**. Иерархическая сборка необходима для обработки исходных данных при сборке шахты что бы:

* сделать в одном источнике данных выгрузку данных по всей иерархии в базе;
* вывести данные по первому столбцу с отступами в зависимости от глубины вложенности

В конфигурации источника настройка `"hierarchyBy"` представляет собой объект с набором свойств: `id`, `parent`, `level`, `order`.
 ```
   hierarchyBy: 
          id: guidProj
          parent: basicobj1.guidObj
          level: objLevel
          order: objOrder
 ```
где `id` - атрибут в данных, идентифицирующий элемент иерархии

`parent` - атрибут в данных, содержащий идентификатор родительского элемента

`level` - атрибут в результирующем источнике, куда будет записан уровень вложенности элемента

`order` - атрибут в результирующем источнике, куда будет записано значение для упорядочивания иерархии при отображении.

Поля `objLevel` и `objOrder` это поля для записи значения (их не надо считать, агрегировать и т.д.):
```yml
reports: 
  - name: roadmap
    caption: Дорожная карта
    sheets: 
      - name: roadmap
        caption: >-
          Дорожная карта
        type: aggregation
        needFilterSet: true
        needFilterMessage: Выберите проект
        styles: 
          objLevel: 
            1: text-indent-1
            2: text-indent-2
            3: text-indent-3
          nameObjIndex: 
            "3": level2
            "2": level1
            "1": level0
            "0": level0
        source: roadmapSource
        fetch: 
          objLevel: $objLevel
          guidObj: $guidObj
          numLevelObj: $numLevelObj
...
```

**NB:** Иерархическая сборка возможна только на основе источника и невозможна на основе класса.

_Алгоритм сборки:_
* Создаем результирующий источник.
* Делаем выборку корневых элементов, у которых пустое поле `parent`. 
* Перебираем и записываем элементы в источник данных (при этом в атрибут `element_id` - идентификатор (id) обьекта, в `level` - значение 0, в `order` - приведенный к строке порядковый номер элемента в выборке, дополненный до длины 6 символов нолями).
* Итеративно делаем выборки следующих уровней вложенности (начиная с 0), до тех пор пока на очередной итерации не будет извлечено 0 объектов. Выборки делаются путем объединения исходного источника с результирующим по связи `parent = element_id` и ограничению `level=текущий уровень` вложенности. 
* На каждой итерации перебираем и записываем элементы в результирующий источник, при этом:
** в спецатрибут `element_id` пишем идентфикатор (id) обьекта, 
** в `level` пишем текущий уровень вложенности, 
** в `order` пишем конкатенацию порядкового номера родительского элемента и приведенного к строке порядкового номера элемента в выборке, дополненного до длины 6 символов нолями.

2. **Настройка скрытия всех объектов**, если табличные фильтры не заданы. Настройка применяется когда необходимо что бы при открытии отчета все объекты скрывались, пока не будет выбрано значение из списка в фильтре:
```
needFilterSet: true
```

3. **Отображение в заголовке отчета параметров выборки.**
```yml
...
          byPeriod:
            sum:
              - if:
                  - and:
                      - gte:
                          - $date
                          - ':since' # берем из params->since
                      - lte:
                          - $date
                          - ':till' # берем из params->till
                  - $amount
                  - 0
          byMonth:
            sum:
              - if:
                  - and:
                      - eq:
                          - month: 
                              - dateAdd:
                                  - $date
                                  - 10
                                  - h
                          - ':month' # берем из params->month
                      - eq:
                          - year: 
                              - dateAdd:
                                  - $date
                                  - 10
                                  - h
                          - ':year' # берем из params->year
                  - $amount
                  - 0
          byYear:
            sum:
              - if:
                  - eq:
                      - year: 
                          - dateAdd:
                              - $date
                              - 10
                              - h
                      - ':year' # берем из params->year
                  - $amount
                  - 0
...
        params:
          year:
            caption: Год
            format: int
          month:
            caption: Месяц
            format: int
            select: # выпадающий список
              '1': январь
              '2': февраль
              '3': март
              '4': апрель
              '5': май
              '6': июнь
              '7': июль
              '8': август
              '9': сентябрь
              '10': октябрь
              '11': ноябрь
              '12': декабрь
          since:
            caption: с
            format: date
          till:
            caption: по
            format: date
...
        columns:
          - field: title
            caption: Показатель
          - field: dimension
            align: center # наименование заголовка в шапке по центру ячейки
            caption: Единица измерения
          - caption: '{$year}' # наименование заголовка в шапке из параметра year
            align: center
            columns: # колонка в шапке - группа вложенных колонок
              - field: byPeriod
                # наименование заголовка в шапке из параметров since и till
                caption: 'c {$since} по {$till}'
                align: center
                format: number
              - field: byMonth
                # наименование заголовка в шапке из параметра month
                caption: 'За {$month}'
                align: center
                format: number
              - field: byYear
                caption: За год
                align: center
                format: number
```

4. **Переопределение значений атрибута для вывода в колоноке таблицы отчета.**

При выводе значений атрибута типа ["Выпадающий список"](https://github.com/iondv/framework/blob/master/docs/ru/2_system_description/metadata_structure/meta_class/atr_selectionprovider.md) в колонке таблицы отчета - отображаться будет системное наименование предзаданного значения атрибута. Переопределить значение для вывода в отчете можно используя следующую настройку для результирующего источника данных: 
```yml
...
        fetch:
          category: $category
          title: # системное наименование колонки отчета
            case: # переопределение
              - eq: # операция (равно)
                  - $category # атрибут
                  - AA4 # значение атрибута
              - 'Выдано заключений, всего в т.ч.:' # переопределенное значение
              - eq:
                  - $category
                  - AB5
              - '1. Государственная экспертиза, всего в т.ч.:'
              - eq:
                  - $category
                  - AC6
              - '- положительных'
              - eq:
                  - $category
                  - AD7
              - '- отрицательных'
...
          dimension:
            case:
              - eq:
                  - $category
                  - AA4
              - штук
              - eq:
                  - $category
                  - AB5
              - штук
```

Далее, можно задавать стиль отображения значения атрибута в колонке таблицы отчета. В примере ниже задается уровень для каждого значения:
```
...
        styles:
          category:
            AA4: level0
            AB5: level1
            AC6: level2
            AD7: level2
```

5. **Выпадающий список в параметрах и фильтрах.**
```yml
...
        params:
          year:
            caption: Год
            format: int
          month:
            caption: Месяц
            format: int
            select: # выпадающий список
              '1': январь
              '2': февраль
              '3': март
              '4': апрель
              '5': май
              '6': июнь
              '7': июль
              '8': август
              '9': сентябрь
              '10': октябрь
              '11': ноябрь
              '12': декабрь
          since:
            caption: с
            format: date
          till:
            caption: по
            format: date
...
```

6. **Обработка параметров в фильтре на странице отчета.**
```yml
reports:
  ...
  filter:
    eq:
      - $yearStart
      - year:
        - ':dateSelect'
  ...
```
Значение года в атрибуте `$yearStart` равно значению года из даты в атрибуте `:dateSelect`.

7. **Настройка пагинатора "pageSize".**

**NB:** Применяется для отчетов с типом `type: list`.

Для случаев, когда отчет содержит в себе много объектов и на страницах нужно выводить строки постранично, чтобы не нагружать браузер тяжелой обработкой данных.
```yml
reports:
 - name: test
    caption: Тестовый отчет
    sheets:
      - name: main
        caption: Тестовый отчет
        type: list
        pageSize: 100
```

8. **Вывод вложенных данных построчно.**

Настройка вывода вложенных данных в отчете построчно настраивается следующим образом: 
```yml
reports:
  - name: testReport
  ...
      columns:
        - caption: Группирующее поле
          columns: # поля для группировки
            - field: columns1
              caption: Поле1
              format: string
            - field: columns2
              caption: Поле2
              format: string
    ...
```

9. **Настройка инкрементальной загрузки.**

_Инкрементальная загрузка — это процесс загрузки только новых или обновленных записей из базы данных._
Для настройки инкрементальной загрузки данных в источник при сборке шахты данных необходимо выставить параметр:
```
append: true
```
Он необходим для подгрузки статистики за день в шахту данных, чтоб не пересчитывать весь объем исходных данных и иметь историю по периодам. 

10. **Особенности сортировки объектов**

Для настройки сортировки объектов по колонке таблицы отчета необходимо задать свойство `sort`. Системное наименование колонки, по которой выполняется сортировка должно соответствовать системному наименованию атрибута отчета, указанном в источнике данных.
```yml
reports:
  - name: sors
    caption: Источник
    sheets:
      ...
        rangeFilters:
          ...
        sort:
          date: asc
        columns:
          ...
```


### Следующая страница: [Настройки конфигурации](/docs/ru/additional_settings.md)